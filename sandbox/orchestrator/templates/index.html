<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Project Bubble ‚Äî Sandbox Runner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --bg:#0b0d10; --panel:#0f141b; --muted:#9ca3af; --border:#2b3440; --text:#e5e7eb;
            --success:#10b981; --warning:#f59e0b; --danger:#ef4444; --info:#3b82f6; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; padding:24px; background:var(--bg); color:var(--text); }
    header { margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid var(--border); }
    .section { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:20px; margin-bottom:16px; }
    .section h3 { margin:0 0 16px 0; font-size:16px; color:var(--text); }
    .row { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    input, button, select, textarea { padding:8px 12px; background:var(--bg); color:var(--text); border:1px solid var(--border); border-radius:8px; font-size:14px; }
    input[type="checkbox"] { width:18px; height:18px; cursor:pointer; }
    button { cursor:pointer; font-weight:500; transition:all .2s; }
    button:hover { background:var(--border); }
    button.primary { background:var(--info); border-color:var(--info); }
    button.primary:hover { opacity:.9; }
    code, pre { background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:13px; white-space:pre-wrap; word-break:break-word; line-height:1.6; }
    .label { color:var(--muted); font-size:13px; display:flex; align-items:center; gap:6px; }
    .chip { display:inline-flex; align-items:center; gap:8px; padding:6px 12px; border:1px solid var(--border); border-radius:8px; background:var(--bg); font-size:13px; margin:4px 4px 4px 0; }
    .alert-box { padding:12px; border-radius:8px; margin-bottom:12px; border-left:4px solid; }
    .alert-danger { background:rgba(239,68,68,.1); border-left-color:var(--danger); color:#fca5a5; }
    .alert-warning { background:rgba(245,158,11,.1); border-left-color:var(--warning); color:#fcd34d; }
    .alert-info { background:rgba(59,130,246,.1); border-left-color:var(--info); color:#93c5fd; }
    .alert-success { background:rgba(16,185,129,.1); border-left-color:var(--success); color:#6ee7b7; }
    .violation-card { background:var(--bg); border:1px solid var(--border); border-left:3px solid var(--danger); padding:12px; margin-bottom:8px; border-radius:6px; }
    .violation-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .violation-syscall { font-weight:600; color:var(--danger); font-family:monospace; }
    .violation-time { font-size:12px; color:var(--muted); }
    .violation-details { font-size:13px; color:var(--muted); line-height:1.6; }
    .permission-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; }
    .permission-item { display:flex; align-items:center; gap:8px; padding:8px; background:var(--bg); border:1px solid var(--border); border-radius:6px; }
    .status-badge { padding:4px 10px; border-radius:12px; font-size:12px; font-weight:500; }
    .status-running { background:var(--info); color:#fff; }
    .status-blocked { background:var(--danger); color:#fff; }
    .status-success { background:var(--success); color:#fff; }
    .status-error { background:var(--warning); color:#fff; }
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    @media (max-width: 900px) { .grid-2 { grid-template-columns:1fr; } }
    .empty-state { text-align:center; padding:40px; color:var(--muted); }
  </style>
</head>
<body>
  <header>
    <h1 style="margin:0 0 8px 0; font-size:24px;">Project Bubble ‚Äî Sandbox Runner</h1>
    <p class="label">Seccomp-based sandboxing with configurable policies</p>
  </header>

  <div class="section">
    <h3>üéØ Launch Configuration</h3>
    <div class="row">
      <input id="cmd" style="flex:1; min-width:300px;" placeholder="Command, e.g. /bin/echo hello or ./test_violations"/>
      <button id="run" class="primary">‚ñ∂ Run Command</button>
    </div>
    <div class="row">
      <input type="file" id="file">
      <input id="interpreter" placeholder="Interpreter (optional), e.g. /bin/sh" style="width:180px;"/>
      <input id="args" placeholder="Args (optional)" style="width:200px;"/>
      <button id="uploadRun" class="primary">üì§ Upload & Run</button>
    </div>
  </div>

  <div class="section">
    <h3>üîê Sandbox Policy</h3>
    <div class="row" style="margin-bottom:8px;">
      <span class="label">Behavior: <strong>deny with EPERM and continue</strong> (no TRAP)</span>
    </div>
    <div class="permission-grid">
      <div class="permission-item">
        <input type="checkbox" id="perm_fs_read" checked disabled>
        <label for="perm_fs_read">üìñ Filesystem Read (always allowed)</label>
      </div>
      <div class="permission-item">
        <input type="checkbox" id="perm_fs_write">
        <label for="perm_fs_write">üìù Allow Filesystem Write (uncheck to deny)</label>
      </div>
      <div class="permission-item">
        <input type="checkbox" id="perm_network">
        <label for="perm_network">üåê Allow Network (uncheck to deny)</label>
      </div>
      <div class="permission-item">
        <input type="checkbox" id="notify_exec" checked>
        <label for="notify_exec">‚öôÔ∏è Log Process Spawns</label>
      </div>
      <div class="permission-item">
        <input type="checkbox" id="pidns">
        <label for="pidns">üîí PID Namespace</label>
      </div>
      <div class="permission-item">
        <input type="checkbox" id="diagnose">
        <label for="diagnose">üîç Diagnostic logging (best-effort)</label>
      </div>
    </div>
  </div>

  <div id="resultsContainer" style="display:none;">
    <div class="section">
      <h3>‚ö†Ô∏è Security Violations</h3>
      <div id="violations"></div>
    </div>

    <div class="grid-2">
      <div class="section">
        <h3>üìä Standard Output</h3>
        <pre id="stdout"></pre>
      </div>
      <div class="section">
        <h3>üìã All Events</h3>
        <div id="alerts"></div>
      </div>
    </div>

    <div class="section">
      <h3>üìà Execution Summary</h3>
      <div id="summary"></div>
      <div id="ids" style="margin-top:12px;"></div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  console.log("[ui] init");

  function buildRequestBody() {
    return {
      diagnose: $("diagnose")?.checked ?? false,
      pidns: $("pidns")?.checked ?? false,
      notify_exec: $("notify_exec")?.checked ?? false,
      permissions: {
        fs_write: $("perm_fs_write")?.checked ?? false,
        network: $("perm_network")?.checked ?? false,
      },
    };
  }

  async function runCommand(body) {
    try {
      console.log("[ui] POST /run", body);
      $("resultsContainer").style.display = "none";
      const res = await fetch("/run", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      const data = await res.json();
      console.log("[ui] /run response", data);
      renderResults(data);
    } catch (e) {
      alert("Request failed: " + e);
    }
  }

  function renderResults(data) {
    $("resultsContainer").style.display = "block";
    renderViolations(data.alerts || []);
    $("stdout").textContent = data.stdout || "(no output)";
    renderAlerts(data.alerts || []);
    renderSummary(data);
  }

  function renderViolations(alerts) {
    const container = $("violations");
    const violations = (alerts || []).filter(a =>
      a.type === "policy.alert" ||
      a.reason === "trap" || a.reason === "errno" ||
      (a.message && a.message.includes("killed by signal"))
    );
    if (violations.length === 0) {
      container.innerHTML = '<div class="alert-success">‚úÖ No security violations detected</div>';
      return;
    }
    container.innerHTML = violations.map(v => {
      const syscall = v.syscall || "unknown";
      const reason  = v.reason || "violation";
      const time = (v.ts || "").split("T")[1]?.split(".")[0] || "";
      const parts = [];
      if (v.path)   parts.push(`Path: <code>${v.path}</code>`);
      if (v.flags)  parts.push(`Flags: <code>${v.flags}</code>`);
      if (v.domain) parts.push(`Domain: <code>${v.domain}</code>`);
      if (v.peer)   parts.push(`Peer: <code>${v.peer}</code>`);
      if (v.port !== undefined && v.port !== -1) parts.push(`Port: <code>${v.port}</code>`);
      if (v.denied) parts.push(`Result: <code>${v.denied}</code>`);
      return `
        <div class="violation-card">
          <div class="violation-header">
            <span class="violation-syscall">${syscall}</span>
            <span class="violation-time">${time}</span>
          </div>
          <div class="violation-details">
            <strong>Reason:</strong> ${reason}<br>
            ${parts.join(" ‚Ä¢ ")}
          </div>
        </div>`;
    }).join("");
  }

  function renderAlerts(alerts) {
    const container = $("alerts");
    if (!alerts || alerts.length === 0) {
      container.innerHTML = '<div class="empty-state">No events recorded</div>';
      return;
    }
    container.innerHTML = alerts.map(ev => {
      const type = ev.type || ev.reason || "event";
      const time = (ev.ts || "").split("T")[1]?.split(".")[0] || "";
      let colorClass = "info";
      if (String(type).includes("alert") || String(type).includes("trap")) colorClass = "danger";
      else if (String(type).includes("spawn") || String(type).includes("exit")) colorClass = "warning";
      return `
        <div class="alert-box alert-${colorClass}">
          <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
            <strong>${type}</strong>
            <span style="font-size:12px;opacity:.8;">${time}</span>
          </div>
          <pre style="margin:0;font-size:12px;background:transparent;border:none;padding:0;">${JSON.stringify(ev, null, 2)}</pre>
        </div>`;
    }).join("");
  }

  function renderSummary(data) {
    const exitCode = data.exit_code ?? "?";
    const signal = data.term_signal;
    let status = "success";
    let statusText = "Completed";
    if (signal) { status = "blocked"; statusText = `Killed by signal ${signal}`; }
    else if (exitCode !== 0) { status = "error"; statusText = `Exit code ${exitCode}`; }
    $("summary").innerHTML = `
      <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
        <span class="status-badge status-${status}">${statusText}</span>
        <div class="chip"><strong>Command:</strong> <code>${(data.command || []).join(" ")}</code></div>
        <div class="chip"><strong>Duration:</strong> ${data.duration_s}s</div>
        <div class="chip"><strong>Max RSS:</strong> ${data.max_rss_kb} KB</div>
        <div class="chip"><strong>Mode:</strong> ${data.mode || ""}</div>
      </div>`;
    $("ids").innerHTML = `
      <div style="display:flex;flex-wrap:wrap;gap:8px;">
        <div class="chip"><strong>Sample ID:</strong> <code>${data.sample_id || ""}</code></div>
        <div class="chip"><strong>Run ID:</strong> <code>${data.run_id || ""}</code></div>
        <div class="chip"><strong>Artifact:</strong> <code>${data.stdout_artifact_id || ""}</code></div>
        ${data.offline ? '<div class="chip" style="border-color: var(--warning);">‚ö†Ô∏è Offline mode</div>' : ''}
      </div>`;
  }

  window.addEventListener("DOMContentLoaded", () => {
    console.log("[ui] DOM ready");

    $("run").addEventListener("click", async () => {
      const body = buildRequestBody();
      body.cmd = $("cmd").value.trim();
      if (!body.cmd) { alert("Enter a command to run"); return; }
      await runCommand(body);
    });

    $("uploadRun").addEventListener("click", async () => {
      const f = $("file").files[0];
      if (!f) { alert("Pick a file first"); return; }
      const fd = new FormData(); fd.append("file", f);
      const u = await fetch("/upload", { method: "POST", body: fd });
      const uj = await u.json();
      if (uj.error) { alert(uj.error); return; }
      const body = buildRequestBody();
      body.uploaded_path = uj.path;
      body.interpreter = $("interpreter").value;
      body.args = $("args").value;
      await runCommand(body);
    });
  });
})();
</script>
</body>
</html>
